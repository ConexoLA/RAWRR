<template>
  <div>
    <b>{{ formDataTemp.title }}</b>
    <div class="vulnerabilityForm">
      <v-container>
        <v-form ref="form" v-model="valid">
          <v-row v-if="formDataTemp.resetFormValidation === true">
            {{ resetFormValidation() }}
          </v-row>
          <v-row no-gutters>
            <v-text-field
              class="mb-3"
              v-model="formDataTemp.vulnerability.name"
              :rules="nameRules"
              :label="$t('forms.name')"
              required
            ></v-text-field>
          </v-row>
          <v-row no-gutters>
            <v-textarea
              v-model="formDataTemp.vulnerability.description"
              :label="$t('global.description')"
              outlined
              rows="5"
              no-resize
            ></v-textarea>
          </v-row>
          <v-row no-gutters>
            <v-select
              v-model="formDataTemp.vulnerability.newThreatsId"
              clearable
              :items="getAllThreats()"
              item-text="name"
              item-value="id"
              :label="$t('global.threats')"
              multiple
              chips
              deletable-chips
            ></v-select>
          </v-row>
          <v-row no-gutters justify="center">
            <v-col cols="5" class="mr-5">
              <v-select
                v-model="formDataTemp.vulnerability.assessment_activity_id"
                :items="getAllAssessmentActivities()"
                item-text="name"
                item-value="id"
                :label="$t('global.assessment_activity')"
                clearable
              ></v-select>
            </v-col>
            <v-col cols="5" class="ml-5">
              <v-select
                v-model="formDataTemp.vulnerability.asset_id"
                :items="getAllAssets()"
                item-text="name"
                item-value="id"
                :label="$t('global.asset')"
                clearable
              ></v-select>
            </v-col>
          </v-row>

          <v-row
            no-gutters
            class="text-end"
            v-if="formDataTemp.type === 'Edit'"
          >
            <v-col>
              <v-btn
                class="mr-4 v-btn v-btn--contained theme--light v-size--default"
                color="primary"
                :disabled="!valid"
                @click="updateElement(formDataTemp.vulnerability)"
                >{{ $t("global.update") }}
              </v-btn>
            </v-col>
          </v-row>
          <v-row
            no-gutters
            class="text-end"
            v-if="formDataTemp.type === 'Create'"
          >
            <v-col>
              <v-btn
                class="mr-4 v-btn v-btn--contained theme--light v-size--default"
                color="primary"
                :disabled="!valid"
                @click="insertElement(formDataTemp.vulnerability)"
                >{{ $t("global.insert") }}
              </v-btn>
            </v-col>
          </v-row>
        </v-form>
      </v-container>
    </div>
  </div>
</template>

<script>
import { mapActions, mapGetters } from "vuex";

export default {
  name: "VulnerabilityForm",
  props: ["formData"],
  created() {
    this.formDataTemp = this.formData;
  },
  computed: {
    nameRules() {
      return [
        (v) => !!v || this.$t("forms.name_restriction_1"),
        (v) => (v && v.length <= 150) || this.$t("forms.name_restriction_2"),
      ];
    },
  },
  data: () => ({
    valid: true,
    alertType: null,
    formDataTemp: null,
  }),
  methods: {
    ...mapActions([
      "fetchAllVulnerabilities",
      "addVulnerability",
      "updateVulnerability",
      "deleteVulnerabilityThreatAssociation",
      "addVulnerabilityThreatAssociation",
      "fetchAllVulnerabilityThreatAssociations",
    ]),
    ...mapGetters([
      "getAllAssessmentActivities",
      "getAllAssets",
      "getAllThreats",
      "getFirstVulnerability",
    ]),
    resetFormValidation() {
      if (this.$refs.form) {
        this.$refs.form.resetValidation();
        this.formDataTemp.resetFormValidation = false;
      }
    },
    updateElement(vulnerability) {
      if (vulnerability.newThreatsId != vulnerability.oldThreatsId) {
        let _vulnerabilityThreatAssociation = {
          vulnerability_id: vulnerability.id,
          threat_id: null,
        };
        vulnerability.oldThreatsId.forEach((oldThreatId) => {
          _vulnerabilityThreatAssociation.threat_id = oldThreatId;
          this.deleteVulnerabilityThreatAssociation(
            _vulnerabilityThreatAssociation
          );
        });
        vulnerability.newThreatsId.forEach((newThreatId) => {
          _vulnerabilityThreatAssociation.threat_id = newThreatId;
          this.addVulnerabilityThreatAssociation(
            _vulnerabilityThreatAssociation
          );
        });
        this.fetchAllVulnerabilityThreatAssociations();
      }
      this.updateVulnerability(vulnerability);
      this.fetchAllVulnerabilities();
      this.$emit("toggle");
    },
    async insertElement(vulnerability) {
      this.addVulnerability(vulnerability);
      await this.fetchAllVulnerabilities();
      if (vulnerability.newThreatsId && vulnerability.newThreatsId.length > 0) {
        let _vulnerabilityThreatAssociation = {
          //return first element in array since it is returned sorted from "backend" by last modified
          vulnerability_id: this.getFirstAssessmentActivity().id,
          threat_id: null,
        };
        vulnerability.newThreatsId.forEach((newThreatId) => {
          _vulnerabilityThreatAssociation.threat_id = newThreatId;
          this.addVulnerabilityThreatAssociation(
            _vulnerabilityThreatAssociation
          );
        });
        await this.fetchAllVulnerabilityThreatAssociations();
        await this.fetchAllVulnerabilities();
      }
      await this.$refs.form.reset();
    },
  },
};
</script>

<style scoped></style>
