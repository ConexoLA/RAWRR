<template>
  <div v-resize="onResize" style="padding: 15px">
    <v-row>
      <v-col cols="auto" align-self="center">
        <v-card class="pa-2" elevation="0">
          <v-card-title>
            {{ $t("vulnerabilities_table_title") }}
          </v-card-title>
          <v-card-subtitle>
            {{ $t("vulnerabilities_table_subtitle") }}
          </v-card-subtitle>
        </v-card>
      </v-col>
      <v-col cols="auto" align-self="center">
        <v-btn medium color="primary" @click="showCreateDialog()">{{
          $t("generic_table_add_element")
        }}</v-btn>
      </v-col>
      <v-col cols="auto" align-self="center">
        <v-btn
          v-if="selected.length"
          medium
          color="error"
          class="ml-2"
          @click="showDeleteDialog(selected)"
          >{{ $t("vulnerability_table_delete_multiple_button") }}
        </v-btn>
      </v-col>
      <v-spacer></v-spacer>
      <v-col cols="auto" xl="4" lg="3" md="2" align-self="center" class="pr-10">
        <v-text-field
          v-model="search"
          append-icon="mdi-magnify"
          :label="$t('generic_table_search_bar_title')"
          clearable
          single-line
          hide-details
        ></v-text-field>
      </v-col>
    </v-row>

    <!-- 64: header, 24: table padding, 59: table footer, 36: page footer, 115: arbitrary value-->
    <v-row no-gutters>
      <v-col cols="12">
        <v-data-table
          fixed-header
          :height="windowSize.y - 64 - 24 - 59 - 36 - 115"
          v-model="selected"
          :headers="headers"
          :items="vulnerabilities"
          item-key="id"
          :items-per-page="-1"
          show-select
          :search="search"
        >
          <template v-slot:[`item.id`]="{ item }">
            <span class="d-inline-block text-truncate" :title="item.id">
              {{ item.id }}
            </span>
          </template>

          <template v-slot:[`item.name`]="{ item }">
            <span
              class="d-inline-block text-truncate"
              :style="`max-width: ${(windowSize.x * 10) / 100}px`"
              :title="item.name"
            >
              {{ item.name }}
            </span>
          </template>

          <template v-slot:[`item.description`]="{ item }">
            <span
              class="d-inline-block text-truncate"
              :style="`max-width: ${(windowSize.x * 10) / 100}px`"
              :title="item.description"
            >
              {{ item.description }}
            </span>
          </template>

          <template v-slot:[`item.assessment_activity_name`]="{ item }">
            <span
              class="d-inline-block text-truncate"
              :style="`max-width: ${(windowSize.x * 7) / 100}px`"
              :title="item.assessment_activity_name"
            >
              {{ item.assessment_activity_name }}
            </span>
          </template>

          <template v-slot:[`item.asset_name`]="{ item }">
            <span
              class="d-inline-block text-truncate"
              :style="`max-width: ${(windowSize.x * 7) / 100}px`"
              :title="item.asset_name"
            >
              {{ item.asset_name }}
            </span>
          </template>

          <template v-slot:[`item.threat_name`]="{ item }">
            <v-responsive
              :style="`max-width: ${(windowSize.x * 10) / 100}px`"
              max-height="100px"
              style="display: block; overflow: auto"
            >
              <v-chip
                v-for="element in item.threat_name"
                :key="element"
                :title="element"
              >
                <span class="d-inline-block text-truncate">
                  {{ element }}
                </span>
              </v-chip>
            </v-responsive>
          </template>

          <template v-slot:[`item.edit`]="props">
            <v-btn text icon color="accent" @click="showEditDialog(props.item)">
              <v-icon>mdi-pencil</v-icon>
            </v-btn>
          </template>

          <template v-slot:[`item.delete`]="props">
            <v-btn
              text
              icon
              color="accent"
              @click="showDeleteDialog([props.item])"
            >
              <v-icon>mdi-delete</v-icon>
            </v-btn>
          </template>
        </v-data-table>
      </v-col>
    </v-row>

    <v-bottom-sheet v-model="sheet" scrollable>
      <v-sheet class="text-center px-4 pt-4 overflow-y-auto">
        <v-btn
          class="mt-6"
          text
          color="error"
          @click="sheet = !sheet"
          absolute
          right
          ><v-icon>mdi-close</v-icon></v-btn
        >
        <div class="my-3">
          <vulnerability-form
            v-bind:formData="formData"
            @toggle="toggleSheet"
          ></vulnerability-form>
        </div>
      </v-sheet>
    </v-bottom-sheet>

    <v-overlay :value="overlay">
      <div
        :style="`
          max-height: ${(windowSize.y * 80) / 100}px;
          max-width: ${(windowSize.x * 80) / 100}px;
          overflow-y: auto;`"
      >
        <v-card color="#FFFFFF" tile>
          <v-card-text>
            <p class="display-1 text--primary">
              {{ $t("generic_delete_item_confirmation") }}
            </p>
            <div v-if="deleteElements.length == 1" class="text--primary">
              {{ $t("vulnerability_delete_description") }}
            </div>
            <div v-if="deleteElements.length > 1" class="text--primary">
              {{ $t("vulnerability_multiple_delete_description") }}
            </div>
            <div
              v-for="element in deleteElements"
              :key="element.id"
              class="ml-5 text--primary"
            >
              (ID: {{ element.id }}) - {{ element.name }}
            </div>
          </v-card-text>
          <v-card-actions>
            <v-spacer></v-spacer>
            <v-btn text color="accent" @click="overlay = false">
              {{ $t("generic_delete_cancel") }}
            </v-btn>
            <v-btn text color="error" @click="confirmDelete()">
              {{ $t("generic_delete_confirm") }}
            </v-btn>
          </v-card-actions>
        </v-card>
      </div>
    </v-overlay>
  </div>
</template>

<script>
import { mapActions, mapGetters } from "vuex";
import VulnerabilityForm from "./VulnerabilityForm.vue";
export default {
  name: "VulnerabilityList",
  components: {
    VulnerabilityForm,
  },
  computed: {
    headers() {
      return [
        {
          text: this.$t("generic_table_header_id"),
          align: "start",
          sortable: false,
          value: "id",
        },
        { text: this.$t("generic_table_header_name"), value: "name" },
        {
          text: this.$t("generic_table_header_description"),
          value: "description",
        },
        {
          text: this.$t("generic_table_header_assessment_activity"),
          value: "assessment_activity_name",
        },
        {
          text: this.$t("generic_table_header_asset"),
          value: "asset_name",
        },
        {
          text: this.$t("generic_table_header_threats"),
          value: "threat_name",
        },
        {
          text: this.$t("generic_table_header_edit"),
          value: "edit",
          sortable: false,
        },
        {
          text: this.$t("generic_table_header_delete"),
          value: "delete",
          sortable: false,
        },
      ];
    },
    //formData gets shaped in showCreateDialog and showEditDialog
    formData() {
      return {};
    },
  },
  props: ["vulnerabilities"],
  methods: {
    ...mapActions(["fetchAllVulnerabilities", "deleteVulnerability"]),
    ...mapGetters(["getAllVulnerabilityThreatAssociations"]),
    onResize() {
      this.windowSize = { x: window.innerWidth, y: window.innerHeight };
    },
    toggleSheet() {
      this.sheet = !this.sheet;
    },
    obtainThreatAssociations: function (id) {
      let allAssociations = this.getAllVulnerabilityThreatAssociations();
      let associationsById = [];
      allAssociations.forEach((association) => {
        if (association.vulnerability_id == id) {
          associationsById.push(association.threat_id);
        }
      });
      return associationsById;
    },
    showCreateDialog() {
      this.fetchAllVulnerabilities();
      this.formData.title = this.$t("vulnerability_form_create");
      this.formData.type = "Create";
      this.formData.vulnerability = {};
      this.formData.resetFormValidation = true;
      this.sheet = !this.sheet;
    },
    showEditDialog(vulnerability) {
      this.fetchAllVulnerabilities();
      this.formData.title = this.$t("vulnerability_form_edit");
      this.formData.type = "Edit";
      this.formData.vulnerability = vulnerability;
      this.formData.vulnerability.oldThreatsId = this.obtainThreatAssociations(
        vulnerability.id
      );
      this.formData.vulnerability.newThreatsId =
        this.formData.vulnerability.oldThreatsId;
      this.formData.resetFormValidation = false;
      this.sheet = !this.sheet;
    },
    showDeleteDialog(element) {
      if (element) {
        this.deleteElements = element;
        this.overlay = !this.overlay;
      }
    },
    confirmDelete() {
      if (this.deleteElements.length) {
        for (const item of this.deleteElements) {
          this.deleteVulnerability(item);
        }
        this.selected = [];
        this.overlay = !this.overlay;
        this.fetchAllVulnerabilities();
      }
    },
  },
  data: () => ({
    sheet: false,
    search: "",
    selected: [],
    deleteElements: [],
    overlay: false,
    windowSize: {
      x: 0,
      y: 0,
    },
  }),
};
</script>

<style>
.max-width-chip.v-chip {
  max-width: calc(50%);
}

.max-width-chip .v-chip__content {
  line-height: 32px;
  padding-right: 30px !important;
  display: inline-block !important;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  position: relative;
}
.max-width-chip .v-chip__close {
  position: absolute;
  top: 5px;
  right: 0;
  width: 24px;
}
</style>
